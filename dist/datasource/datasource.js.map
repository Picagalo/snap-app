{"version":3,"sources":["../../src/datasource/datasource.js"],"names":[],"mappings":";;;;;;;;;;;;;AACQ;;;;;;;;;;;;;;;;;;;;;gCAEF;AAEJ,iBAFI,cAEJ,CAAY,gBAAZ,EAA8B,KAA9B,EAAqC,UAArC,EAAkD;gCAF9C,gBAE8C;;AAChD,eAAK,gBAAL,GAAwB,gBAAxB,CADgD;AAEhD,eAAK,GAAL,GAAW,iBAAiB,GAAjB,CAFqC;AAGhD,eAAK,KAAL,GAAa,KAAb,CAHgD;AAIhD,eAAK,UAAL,GAAkB,UAAlB,CAJgD;SAAlD;;qBAFI;;kCASI,SAAS;AACf,oBAAQ,GAAR,GAAc,KAAK,GAAL,GAAW,QAAQ,GAAR,CADV;AAEf,mBAAO,KAAK,UAAL,CAAgB,iBAAhB,CAAkC,OAAlC,CAAP,CAFe;;;;qCAKN;AACT,mBAAO,KAAK,OAAL,CAAa,EAAC,QAAQ,KAAR,EAAe,KAAK,WAAL,EAA7B,EAAgD,IAAhD,CAAqD,eAAO;AACjE,kBAAI,CAAC,IAAI,IAAJ,IAAY,CAAC,IAAI,IAAJ,CAAS,IAAT,IAAiB,CAAC,IAAI,IAAJ,CAAS,IAAT,CAAc,cAAd,EAA8B;AAChE,uBAAO,EAAP,CADgE;eAAlE;;AAIA,qBAAO,IAAI,IAAJ,CAAS,IAAT,CAAc,cAAd,CAL0D;aAAP,CAA5D,CADS;;;;wCAUG;AACZ,mBAAO,QAAQ,OAAR,CAAgB,EAAC,MAAM,EAAN,EAAjB,CAAP,CADY;;;;gCAIR,SAAS;AACb,gBAAI,SAAS,QAAQ,OAAR,CAAgB,CAAhB,CAAT,CADS;AAEb,gBAAI,CAAC,MAAD,IAAW,CAAC,OAAO,IAAP,IAAe,CAAC,OAAO,IAAP,CAAY,EAAZ,EAAgB;AAC9C,qBAAO,KAAK,WAAL,EAAP,CAD8C;aAAhD;;AAIA,gBAAI,OAAO,OAAO,IAAP,CANE;;AAQb,gBAAI,KAAK,UAAL,EAAiB;AACnB,kBAAI,KAAK,EAAL,KAAY,KAAK,WAAL,EAAkB;AAChC,qBAAK,YAAL,CAAkB,WAAlB,GADgC;AAEhC,qBAAK,YAAL,GAAoB,IAApB,CAFgC;AAGhC,qBAAK,UAAL,GAAkB,IAAlB,CAHgC;eAAlC,MAIO;AACL,uBAAO,KAAK,WAAL,EAAP,CADK;eAJP;aADF;;AAUA,gBAAI,WAAW,KAAK,GAAL,GAAW,YAAX,GAA0B,KAAK,EAAL,GAAU,QAApC,CAlBF;AAmBb,iBAAK,UAAL,GAAkB,WAAW,MAAX,CAAkB,oBAAY;;AAE9C,kBAAI,SAAS,IAAI,WAAJ,CAAgB,QAAhB,CAAT,CAF0C;AAG9C,qBAAO,SAAP,GAAmB,UAAS,GAAT,EAAc;AAC/B,wBAAQ,GAAR,CAAY,eAAZ,EAA6B,GAA7B,EAD+B;eAAd,CAH2B;AAM9C,qBAAO,MAAP,GAAgB,UAAS,GAAT,EAAc;AAC5B,wBAAQ,GAAR,CAAY,aAAZ,EAA2B,GAA3B,EAD4B;eAAd,CAN8B;AAS9C,qBAAO,OAAP,GAAiB,UAAS,GAAT,EAAc;AAC7B,wBAAQ,GAAR,CAAY,aAAZ,EAA2B,GAA3B,EAD6B;eAAd,CAT6B;;AAa9C,qBAAO,YAAM;AACX,wBAAQ,GAAR,CAAY,sBAAZ,EADW;AAEX,uBAAO,KAAP,GAFW;eAAN,CAbuC;aAAZ,CAApC,CAnBa;;AAsCb,iBAAK,YAAL,GAAoB,KAAK,UAAL,CAAgB,SAAhB,CAA0B,gBAAQ;AACpD,sBAAQ,GAAR,CAAY,WAAZ,EAAyB,IAAzB,EADoD;aAAR,CAA9C,CAtCa;;AA0Cb,mBAAO,QAAQ,OAAR,CAAgB,EAAC,MAAM,EAAN,EAAjB,CAAP,CA1Ca;;;;eA5BX;;;gCA2EE","file":"datasource.js","sourcesContent":["\nimport {Observable} from 'vendor/npm/rxjs/Observable';\n\nclass SnapDatasource {\n\n  constructor(instanceSettings, $http, backendSrv)  {\n    this.instanceSettings = instanceSettings;\n    this.url = instanceSettings.url;\n    this.$http = $http;\n    this.backendSrv = backendSrv;\n  }\n\n  request(options) {\n    options.url = this.url + options.url;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  getTasks() {\n    return this.request({method: 'get', url: '/v1/tasks'}).then(res => {\n      if (!res.data || !res.data.body || !res.data.body.ScheduledTasks) {\n        return [];\n      }\n\n      return res.data.body.ScheduledTasks;\n    });\n  }\n\n  emptyResult() {\n    return Promise.resolve({data: []});\n  }\n\n  query(options) {\n    var target = options.targets[0];\n    if (!target || !target.task || !target.task.id) {\n      return this.emptyResult();\n    }\n\n    var task = target.task;\n\n    if (this.observable) {\n      if (task.id !== this.lastWatchId) {\n        this.subscription.unsubscribe();\n        this.subscription = null;\n        this.observable = null;\n      } else {\n        return this.emptyResult();\n      }\n    }\n\n    var watchUrl = this.url + '/v1/tasks/' + task.id + '/watch';\n    this.observable = Observable.create(observer => {\n\n      var source = new EventSource(watchUrl);\n      source.onmessage = function(evt) {\n        console.log('event message', evt);\n      };\n      source.onopen = function(evt) {\n        console.log('open stream', evt);\n      };\n      source.onerror = function(evt) {\n        console.log('event error', evt);\n      };\n\n      return () => {\n        console.log('closing event stream');\n        source.close();\n      };\n    });\n\n    this.subscription = this.observable.subscribe(data => {\n      console.log('snap data', data);\n    });\n\n    return Promise.resolve({data: []});\n  }\n\n}\n\nexport {SnapDatasource};\n"]}