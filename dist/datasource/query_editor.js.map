{"version":3,"sources":["../../src/datasource/query_editor.js"],"names":[],"mappings":"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","file":"query_editor.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\n\nimport _ from 'lodash';\n\nclass SnapQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.removeMetricOption = this.uiSegmentSrv.newSegment({fake: true, value: '-- remove metric --'});\n\n    this.target.taskName = this.target.taskName || 'select task';\n    this.target.taskId = this.target.taskId || '';\n    this.target.metrics = this.target.metrics || [];\n    this.target.interval = this.target.interval || '1s';\n\n    this.taskSegment = this.uiSegmentSrv.newSegment({\n      value: this.target.taskName,\n      cssClass: \"tight-form-item-xxlarge\",\n    });\n\n    if (this.target.taskName === 'select task') {\n      this.taskSegment.fake = true;\n    }\n\n    this.metricSegments = this.target.metrics.map(item => {\n      return this.uiSegmentSrv.newSegment({value: item.namespace, cssClass: 'last'});\n    });\n\n    this.metricSegments.push(this.uiSegmentSrv.newPlusButton());\n    this.getTaskInfo();\n  }\n\n  getTasks() {\n    return this.datasource.getTasks().then(tasks => {\n      this.taskMap = {};\n\n      return tasks.map(task => {\n        this.taskMap[task.name] = task;\n\n        return this.uiSegmentSrv.newSegment({value: task.name});\n      });\n    });\n  }\n\n  taskChanged() {\n    var task = this.taskMap[this.taskSegment.value];\n    if (task) {\n      this.target.taskName = task.name;\n      this.target.taskId = task.id;\n      this.getTaskInfo();\n    } else {\n      this.target.taskId = '';\n      this.target.taskName = this.taskSegment.value;\n    }\n  }\n\n  getMetricSegments(segment) {\n    return this.datasource.getMetrics().then(metrics => {\n      var elements = metrics.map(item => {\n        return this.uiSegmentSrv.newSegment({value: item.value});\n      });\n\n      if (!segment.fake) {\n        elements.unshift(_.clone(this.removeMetricOption));\n      }\n\n      return elements;\n    });\n  }\n\n  metricSegmentChanged(segment, index) {\n    if (segment.value === this.removeMetricOption.value) {\n      this.metricSegments.splice(index, 1);\n    } else {\n      if (segment.type === 'plus-button') {\n        segment.type = '';\n      }\n\n      if ((index+1) === this.metricSegments.length) {\n        this.metricSegments.push(this.uiSegmentSrv.newPlusButton());\n      }\n    }\n\n    this.target.metrics = this.metricSegments.reduce((memo, item) => {\n      if (!item.fake) {\n        memo.push({namespace: item.value});\n      }\n      return memo;\n    }, []);\n  }\n\n  deleteTask() {\n    this.datasource.deleteTask(this.target.taskId).then(() =>  {\n      this.target.taskId = null;\n      this.target.taskName = \"\";\n      this.taskSegment.value = 'select task';\n      this.taskSegment.html = 'select task';\n      this.taskSegment.fake = true;\n      this.taskNotFound = true;\n      this.task = null;\n      this.isRunning = false;\n    });\n  }\n\n  createTask() {\n    this.datasource.createTask(this.target).then(task =>  {\n      this.target.taskId = task.id;\n      this.getTaskInfo();\n    });\n  }\n\n  getTaskInfo() {\n    if (!this.target.taskId) {\n      this.taskNotFound = true;\n      return;\n    }\n\n    this.datasource.getTask(this.target.taskId).then(task =>  {\n      if (!task) {\n        this.task = null;\n        this.target.taskId = '';\n        this.taskNotFound = true;\n        return;\n      }\n      this.taskNotFound = false;\n      this.task = task;\n      this.isRunning = task.task_state === 'Running';\n      this.isStopped = task.task_state === 'Stopped';\n    });\n  }\n\n  startTask() {\n    this.datasource.startTask(this.target.taskId)\n      .then(this.getTaskInfo.bind(this));\n  }\n\n  stopTask() {\n    this.panelCtrl.dataStream.stop();\n    this.datasource.stopTask(this.target.taskId)\n      .then(this.getTaskInfo.bind(this));\n  }\n\n  watchTask() {\n    this.panelCtrl.dataStream.start();\n  }\n}\n\nSnapQueryCtrl.templateUrl = 'datasource/query_editor.html';\nexport {SnapQueryCtrl};\n"]}